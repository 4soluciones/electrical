{% extends 'home.html' %}

{% block title %}
    Orden | Ventas
{% endblock title %}

{% block body %}
    <!-- Content -->
    <div class="container-fluid roboto-condensed-regular">
        <!-- Header Section -->
        <div class="row mb-4 mt-2">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary">
                        <h5 class="mb-0 roboto-condensed-regular text-white">
                            <i class="fas fa-chart-line me-2"></i>
                            Reporte de Ventas
                        </h5>
                    </div>
                    <div class="card-body">
                        <form class="row g-3 align-items-end" id="search-form" method="POST">
                            {% csrf_token %}

                            <!-- Fecha Inicial -->
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <label class="form-label fw-bold" for="id-start-date">
                                    <i class="fas fa-calendar-alt me-1 mr-1"></i>Fecha Inicial
                                </label>
                                <input type="date" class="form-control" id="id-start-date" name="start-date"
                                       value="{{ formatdate }}">
                            </div>

                            <!-- Fecha Final -->
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <label class="form-label fw-bold" for="id-end-date">
                                    <i class="fas fa-calendar-alt me-1 mr-1"></i>Fecha Final
                                </label>
                                <input type="date" class="form-control" id="id-end-date" name="end-date"
                                       value="{{ formatdate }}">
                            </div>

                            <!-- Tipo de Comprobante -->
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <label class="form-label fw-bold" for="id-voucher-type">
                                    <i class="fas fa-file-invoice me-1 mr-1"></i>Tipo de Comprobante
                                </label>
                                <select class="form-select form-control" id="id-voucher-type" name="voucher-type">
                                    <option value="TODOS" selected>TODOS</option>
                                    <option value="T">CONSIGNACIÓN</option>
                                    <option value="B">BOLETA</option>
                                    <option value="F">FACTURA</option>
                                </select>
                            </div>

                            <!-- Botón Buscar -->
                            <div class="col-lg-2 col-md-4 col-sm-6">
                                <button type="submit" class="btn btn-primary w-100" id="btn-search">
                                    <i class="fas fa-search me-2 d-none d-sm-inline"></i>
                                    <span class="d-sm-none">Buscar</span>
                                    <span class="d-none d-sm-inline">Buscar</span>
                                </button>
                            </div>

                            <!-- Clasificación de Colores -->
                            <div class="col-lg-4 col-md-12 col-sm-12">
                                <label class="form-label fw-bold mb-2">
                                    <i class="fas fa-palette me-1 mr-1"></i>Clasificación de Pagos
                                </label>
                                <div class="d-flex flex-wrap gap-3 align-items-center">
                                    <div class="d-flex align-items-center mr-2">
                                        <div class="payment-indicator bg-success me-2 mr-1"></div>
                                        <span class="fw-semibold text-dark small">Depósito</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <div class="payment-indicator bg-info me-2 mr-1"></div>
                                        <span class="fw-semibold text-dark small">Crédito</span>
                                    </div>

                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>


        <!-- Loading Overlay -->
        <div class="position-relative mt-3">
            <div class="loading-overlay" id="loading-666" style="display: none;">
                <div class="d-flex justify-content-center align-items-center h-100">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status">
                        </div>
                        <h5 class="text-primary d-none d-md-block">Cargando...</h5>
                        <h6 class="text-primary d-md-none">Procesando...</h6>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="sales-grid-list"></div>
        </div>
    </div>

    <!-- Modal para Notas de Crédito -->
    <div class="modal fade" id="modal-credit-note" data-backdrop="static" data-keyboard="false" tabindex="-1"
         aria-labelledby="staticBackdropLabel" aria-hidden="true"></div>

    <!-- Estilos personalizados -->
    <style>
        .loading-overlay {
            position: absolute;
            top: 125px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 1000;
            border-radius: 0.375rem;
        }

        .card {
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .card-header {
            border-radius: 0.75rem 0.75rem 0 0 !important;
            background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
        }

        .form-control, .form-select {
            border-radius: 0.5rem;
            border: 1px solid #dee2e6;
            transition: all 0.2s ease-in-out;
        }

        .form-control:focus, .form-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
            transform: translateY(-1px);
        }

        .btn {
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.15);
        }

        .badge {
            border-radius: 0.375rem;
        }

        .form-label {
            color: #495057;
            font-size: 0.9rem;
        }

        .card-body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .payment-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .alert-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border-left: 4px solid #17a2b8;
            font-size: 0.75rem;
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .card-header h5 {
                font-size: 1.1rem;
            }

            .form-label {
                font-size: 0.85rem;
            }

            .payment-indicator {
                width: 12px;
                height: 12px;
            }

            .alert {
                font-size: 0.75rem;
            }
        }

        @media (max-width: 576px) {
            .card-header h5 {
                font-size: 1rem;
            }

            .form-label {
                font-size: 0.8rem;
            }

            .btn {
                font-size: 0.9rem;
                padding: 0.5rem 1rem;
            }

            .gap-3 {
                gap: 0.5rem !important;
            }

            .gap-4 {
                gap: 0.75rem !important;
            }

            .payment-indicator {
                width: 10px;
                height: 10px;
            }
        }

        /* Hover effects for better UX */
        .payment-indicator:hover {
            transform: scale(1.1);
            transition: transform 0.2s ease;
        }
    </style>
{% endblock body %}

{% block extrajs %}
    <script type="text/javascript">

        let selectedSerials = [];

        $('#search-form').submit(function (event) {
            event.preventDefault();
            let data = new FormData($('#search-form').get(0));

            $('#btn-search').attr("disabled", "true");
            $('#sales-grid-list').empty();
            $('#loading-666').show();

            $.ajax({
                url: '/sales/get_sales_by_subsidiary_store/',
                type: "POST",
                data: data,
                cache: false,
                processData: false,
                contentType: false,
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        $('#sales-grid-list').html(response.grid);
                        $('#loading-666').hide();
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    if (jqXhr.status === 500) {
                        toastr.error(jqXhr.responseJSON.error, '¡Error!');
                        $('#loading-666').hide();
                    }
                }
            });
            $('#btn-search').removeAttr("disabled");

        });

        $(document).on('click', '.btn-cancel', function () {

            let $row = $(this).parent('td').parent('tr');
            let $o_id = $row.attr('pk');
            $('#table-dictionary tr[pk="' + $o_id + '"]').addClass('bg-warning');

            setTimeout(() => {
                let r = confirm("¿ESTA SEGURO DE ANULAR LA ORDEN DE VENTA SELECCIONADO?");
                if (r === true) {
                    let pk = $(this).attr("pk")
                    $.ajax({
                        url: '/sales/cancel_order/',
                        async: true,
                        dataType: 'json', // for response
                        type: 'GET',
                        data: {
                            'pk': pk,
                            'start-date': $('#id-start-date').val(),
                            'end-date': $('#id-end-date').val()
                        },
                        contentType: 'application/json;charset=UTF-8',
                        headers: {"X-CSRFToken": '{{ csrf_token }}'},
                        success: function (response, textStatus, xhr) {
                            if (xhr.status === 200) {
                                toastr.success(response.message, '¡ORDEN ACTUALIZADA CORRECTAMENTE!');
                                $('#sales-grid-list').html(response.grid);
                                // $('#table-dictionary tr[pk="' + $o_id + '"]').remove();
                            }
                        },
                        fail: function (response) {
                            console.log("error")
                            toastr.error(jqXhr.responseJSON.error, '¡Inconcebible!');
                        }
                    });
                } else {
                    $('#table-comodity tr[pk="' + $o_id + '"]').removeClass('bg-warning');

                }
            }, 50);
        });

        $(document).on('click', '.btn-credit-note', function () {

            let pk = $(this).attr("pk")
            $.ajax({
                url: '/sales/modal_credit_note/',
                async: true,
                dataType: 'json', // for response
                type: 'GET',
                data: {
                    'pk': pk,
                    'start-date': $('#id-start-date').val(),
                    'end-date': $('#id-end-date').val()
                },
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    $('#modal-credit-note').empty().html(response.grid).modal('show');
                    orderObj = JSON.parse(response.serialized_obj);
                    orderObj["details"] = response.serialized_detail_set;
                    orderObj["newTotal"] = 0;
                    orderObj["newIgv"] = 0;
                    orderObj["newBase"] = 0;
                    let base = 0;
                    let igv = 0;
                    let total = 0;
                    total = Number(response.orderTotal);
                    base = total / 1.18;
                    igv = total - base;
                    selectedSerials = []
                    /*if (orderObj["voucher_type"] === 'F') {  // with igv
                        total = Number(response.orderTotal);
                        base = total / 1.18;
                        igv = total - base;
                    } else {  // without igv
                        base = Number(response.orderTotal);
                        igv = base * 0.18;
                        total = base + igv;
                    }*/
                    $(`table#table-detail-guide tfoot tr td input.old-igv`).val(igv.toFixed(4));
                    $(`table#table-detail-guide tfoot tr td input.old-base`).val(base.toFixed(4));
                    $(`table#table-detail-guide tfoot tr td input.old-total`).val(total.toFixed(4));
                },
                fail: function (response) {
                    console.log("error")
                    toastr.error(jqXhr.responseJSON.error, '¡Inconcebible!');
                }
            });
        });

        $(document).on('input', '.quantity-returned-credit', function () {

            if (Number($(this).val()) > Number($(this).attr('max-value'))) {
                alert('Verifique cantidad a devolver');
                $(this).val("")
            } else {
                let pk = $(this).attr('detail-id');
                let tr = $(`table#table-detail-guide tbody tr[pk=${pk}]`);
                let findDetailObj = orderObj.details.find((d) => {
                    return d.detailID === parseInt(pk)
                });
                let price = Number(findDetailObj["price"]);
                let quantityReturned = Number($(this).val());
                let subtotal = Number(price * quantityReturned).toFixed(4);
                findDetailObj["quantityReturned"] = Number(quantityReturned);
                findDetailObj["newSubtotal"] = Number(subtotal);
                findDetailObj["isCreditNote"] = (quantityReturned > 0);
                tr.find(`td input.new-subtotal`).val(subtotal);
            }
            calculateNewTotalCredit()
        });

        function calculateNewTotalCredit() {

            const res = orderObj.details.reduce((acc, item) => {
                return acc += Number(item.newSubtotal);
            }, 0);

            let base = 0;
            let igv = 0;
            let total = 0;
            total = Number(res);
            base = total / 1.18;
            igv = total - base;
            /*if (orderObj["is_igv"]) {  // with igv
                total = Number(res);
                base = total / 1.18;
                igv = total - base;
            } else {  // without igv
                base = Number(res);
                igv = base * 0.18;
                total = base + igv;
            }*/

            $(`table#table-detail-guide tfoot tr td input.new-base`).val(base.toFixed(4));
            $(`table#table-detail-guide tfoot tr td input.new-igv`).val(igv.toFixed(4));
            $(`table#table-detail-guide tfoot tr td input.new-total`).val(total.toFixed(4));

        }


        $('#btn-switch').click(function () {
            $('.hide-column').remove()
            $('#table-dictionary').bootstrapTable('refresh');
            // $('.hide-column').css('width', '4%')

        });


        function forceDownload(url, filename) {
            fetch(url)
                .then(response => response.blob())
                .then(blob => {
                    const link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = filename || 'archivo.pdf';
                    link.click();
                    window.URL.revokeObjectURL(link.href); // Limpieza
                })
                .catch(error => {
                    console.error('Error al descargar:', error);
                });
        }


        $(document).ready(function () {

            // Funcionalidad del filtro por tipo de comprobante


        });

    </script>
{% endblock extrajs %}
