{% extends 'home.html' %}
{% load static %}
{% load operations %}
{% block title %}
    Ventas
{% endblock title %}

{% block body %}

    {% if error != "" %}
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Inconcebible!</h4>
            <p>{{ error }}</p>
            <hr>
        </div>
    {% endif %}

    <input type="hidden" class="form-control form-control-sm type" id="id_order_sale_quotation" value="">
    <input type="hidden" class="form-control form-control-sm type" id="id_order_sale_quotation_correlative" value="">

    <div class="card-group m-2 bg-light" style="display: flex;">
        <div class="card p-0" style="flex: 0 0 46%;">
            <div id="product_list_sales" class="roboto-condensed-regular">
                <strong class="m-0 p-0 vh-100 row justify-content-center align-items-center">Atencion! Ingrese un texto
                    para comenzar la búsqueda...</strong>
            </div>
            <div class="loader-container col-auto" id="loader-product" style="display: none">
                <div class="loader"></div>
            </div>
        </div>

        <div class="card p-0" style="flex: 0 0 54%;" id="tab-two">
            {% include "sales/sales_grid_tab1.html" %}
        </div>


    </div>



    <!-- card-group -->
    <!-- Modal -->
    {#    <div class="modal fade bd-example-modal-xl" id="add-modal" tabindex="-1" role="dialog"#}
    {#         aria-labelledby="exampleModalLabel" aria-hidden="true"></div>#}

{#    <div class="modal fade" id="modal-voucher" tabindex="-1" role="dialog" aria-labelledby="ModalHelpTitle"#}
{#         aria-hidden="true">#}
{#        <div class="modal-dialog modal-lg modal-dialog-centered roboto-condensed-regular" role="document">#}
{#            <div class="modal-content">#}
{#                <div class="modal-header" style="background: #0b55a4">#}
{#                    <h6 class="modal-title  text-white">TIPOS DE COMPROBANTES</h6>#}
{#                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">#}
{#                        <span aria-hidden="true">&times;</span>#}
{#                    </button>#}
{#                </div>#}
{#                <div class="modal-body">#}
{##}
{#                    <div class="row col-sm-12 p-0 m-0 menu-sales">#}
{##}
{#                        <div class="col-sm-6">#}
{##}
{#                            <div class="card m-0" style="border-color: #0f478a">#}
{##}
{#                                <div class="card-header text-center" style="background: #0f478a">#}
{#                                    <label class="card-title m-0 text-white"> FORMATO TICKETS</label>#}
{#                                </div>#}
{##}
{#                                <div class="card-body">#}
{#                                    <div class="row col-sm-12 p-0 m-0">#}
{#                                        <div class="col-sm-4">#}
{#                                            <button type="button" id="save-order" onclick="create_voucher('T', 'T')"#}
{#                                                    class="btn btn-sm btn-outline-success">#}
{#                                                <i class="fas fa-ticket-alt"></i> TICKET INTERNO#}
{#                                            </button>#}
{#                                        </div>#}
{#                                        <div class="col-sm-6">#}
{#                                            <button type="button" id="btn-invoice-ticket"#}
{#                                                    onclick="create_voucher('F', 'T')"#}
{#                                                    class="btn btn-sm btn-outline-success">#}
{#                                                <i class="fas fa-ticket-alt"></i> FACTURA FORMATO TICKET#}
{#                                            </button>#}
{#                                        </div>#}
{#                                        <div class="col-sm-6">#}
{#                                            <button type="button" id="btn-bill-ticket"#}
{#                                                    onclick="create_voucher('B', 'T')"#}
{#                                                    class="btn btn-sm btn-outline-success">#}
{#                                                <i class="fas fa-ticket-alt"></i> BOLETA FORMATO TICKET#}
{#                                            </button>#}
{#                                        </div>#}
{#                                    </div>#}
{#                                </div>#}
{#                            </div>#}
{##}
{#                        </div>#}
{#                        <div class="col-sm-6">#}
{#                            <div class="card m-0" style="border-color: #0f478a">#}
{#                                <div class="card-header text-center" style="background: #0f478a">#}
{#                                    <label class="card-title m-0 text-white"> FORMATO A4</label>#}
{#                                </div>#}
{#                                <div class="card-body pt-2">#}
{#                                    <div class="row col-sm-12">#}
{#                                        <div class="col-sm-12 text-center">#}
{#                                            <div class="form-check mb-2">#}
{#                                                <input class="form-check-input check-print-series" type="checkbox"#}
{#                                                       value=""#}
{#                                                       id="check_print_series">#}
{#                                                <label class="form-check-label font-weight-bold text-danger"#}
{#                                                       for="check_print_series">#}
{#                                                    IMPRIMIR SERIES#}
{#                                                </label>#}
{#                                            </div>#}
{#                                        </div>#}
{#                                    </div>#}
{#                                    <div class="row col-sm-12 p-0 m-0">#}
{##}
{#                                        <div class="col-sm-6">#}
{#                                            <button type="button" id="btn-invoice-a4"#}
{#                                                    onclick="create_voucher('F', 'A4')"#}
{#                                                    class="btn btn-sm btn-outline-secondary btn-block">#}
{#                                                <i class="fas fa-file-invoice"></i> FACTURA FORMATO A4#}
{#                                            </button>#}
{#                                        </div>#}
{##}
{#                                        <div class="col-sm-6">#}
{#                                            <button type="button" id="btn-bill-a4" onclick="create_voucher('B', 'A4')"#}
{#                                                    class="btn btn-sm btn-outline-secondary btn-block">#}
{#                                                <i class="fas fa-file-invoice"></i> BOLETA <br>FORMATO A4#}
{#                                            </button>#}
{#                                        </div>#}
{#                                    </div>#}
{#                                </div>#}
{#                            </div>#}
{#                        </div>#}
{#                    </div>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{#    </div>#}

    <!----------------------- Modal Client----------------------------->
    <div class="modal fade" id="modalClient" data-backdrop="static" data-keyboard="false" tabindex="-1"
         aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">Nuevo Cliente:</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <table class="table table-sm table-borderless small font-weight-bolder text-uppercase">
                        <tbody>
                        <tr>
                            <th scope="row" style="width: 40%;">
                                <label for="surnames">Tipo de documento</label>
                            </th>
                            <td>
                                <select id="document_type_client" name="document_type_client" class="form-control"
                                        style="font-size: .9375rem;">
                                    {% for type in document_types %}
                                        {% if type.id == '01' %}
                                            <option value="{{ type.id }}">DOCUMENTO NACIONAL DE IDENTIDAD</option>
                                        {% elif type.id == '06' %}
                                            <option value="{{ type.id }}">REGISTRO UNICO CONTRIBUYENTE (RUC)</option>
                                        {% elif type.id == '00' %}
                                            <option value="{{ type.id }}">OTRO</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">
                                <label for="document_number_client">Nº de Documento</label>
                            </th>
                            <td>
                                <input type="text" class="form-control" id="document_number_client"
                                       name="document_number_client"
                                       autocomplete="off">
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">
                                <label for="names">Nombres</label>
                            </th>
                            <td>
                                <input type="text" class="form-control" name="names" id="client-names">
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">
                                <label for="phone">Telefono</label>
                            </th>
                            <td>
                                <input type="text" class="form-control" name="phone" id="client-phone">
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">
                                <label for="email">E-mail</label>
                            </th>
                            <td>
                                <input type="text" class="form-control" name="email" id="client-email">
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">
                                <label for="address">Direccion</label>
                            </th>
                            <td>
                                <input type="text" class="form-control" name="address" id="client-address">
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">
                                <label for="id_district">Distritos</label>
                            </th>
                            <td>
                                <select id="id_district" name="id_district" class="form-control">
                                    <option value="0">SELECCIONAR</option>
                                    {% for district in districts %}
                                        <option value="{{ district.id }}">{{ district.description }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">
                                <label for="reference">Referencia</label>
                            </th>
                            <td>
                                <input type="text" class="form-control" name="reference" id="client-reference">

                            </td>
                        </tr>
                        </tbody>
                    </table>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Salir</button>
                    <button type="button" class="btn btn-primary" id="save-new-client">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>
    <!----------------------- Modal Client----------------------------->

    <div class="modal fade" id="modal-serial" tabindex="-1" role="dialog"
         aria-labelledby="ModalHelpTitle" data-backdrop="static" data-keyboard="false"
         aria-hidden="true"></div>

    <div class="mr-3 ml-0" style="
            display: none;
            position: absolute;
            top: 231px;
            left: 888px;
            background: #e9ecef;
            opacity: 0.8;
            width: 52.6%;
            {#height: 46em;#}
            !important;bottom: 560px;
            padding-right: 0em;
            padding-top: 0em;" id="loading-666"></div>
    <div class="mr-3 ml-0" style="
            display: none;
            position: absolute;
            top: 69px;
            left: 880px;
            background: #e9ecef;
            opacity: 0.8;
            width: 53.4%;
            height: 100%;
            {#!important;bottom: 560px;#}
            padding-right: 0em;
            padding-top: 11em;" id="loading-bill"></div>

    <div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title roboto-condensed-regular font-weight-bold text-center" id="imageModalLabel"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" class="img-fluid" src="" alt="No-img">
                </div>
            </div>
        </div>
    </div>
    <div class="loader-container col-auto text-center">
        <div class="spinner-border border-0 d-none" id="loading-bill" role="status" style="width: auto; height: auto">
            <img class="animation__shake img-circle" src="{% static 'img/LOGO.png' %}" alt="Logo"
                 height="40"
                 width="40">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

{#    <style>#}
{#        div.dataTables_wrapper div#product-data-grid_filter {#}
{#            width: 100%;#}
{#            float: none;#}
{#            text-align: center;#}
{#        }#}
{##}
{#        div.dataTables_wrapper div#product-data-grid_filter label input[type='Search'] {#}
{#            width: 300px;#}
{#        }#}
{#    </style>#}
{% endblock body %}

{% block extrajs %}

    <script type="text/javascript">

        /*$(document).ready(function() {
            // Prevenir el envío del formulario al presionar "Enter"
            $('#order-form input').on('keypress', function(e) {
                if (e.which === 13) { // 13 es el código de la tecla "Enter"
                    e.preventDefault();
                }
            });
        });*/

        loader = '<div class="container">' +
            '<div class="row">' +
            '<div class="col-md-12">' +
            '<div class="loader">' +
            '<strong class="roboto-condensed-regular" style="font-size: 12px"> Buscando...</strong>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';

        loader2 = '<div class="container">' +
            '<div class="row">' +
            '<div class="col-md-12">' +
            '<div class="loader">' +
            '<strong class="roboto-condensed-regular" style="font-size: 12px"> Cargando Comprobante...</strong>' +
            '<div class="spinner-grow" role="status">' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';

        document.querySelectorAll('.check-search').forEach(radio => {
            radio.addEventListener('change', function () {
                if (this.checked) {
                    if (this.value === 'document') {
                        console.log('Acción para búsqueda por documento');
                        $('.row.for-document').removeClass('d-none');
                        $('.row.for-name').addClass('d-none');
                        $('#client_name').val('');
                        $('#client_address').val('');
                        $('#document_number_client').val('').focus();
                        $('#client_id').val('');
                    } else if (this.value === 'name') {
                        console.log('Acción para búsqueda por nombre');
                        $('.row.for-name').removeClass('d-none');
                        $('.row.for-document').addClass('d-none');
                        $('#person_address').val('');
                        $('#person-names').val('').focus();
                        $('#client_id').val('');
                    }
                }
            });
        });

        new Autocomplete('#autocomplete-client', {
            search: input => {
                const url = `/sales/get_client_search/?search=${encodeURI(input.toUpperCase())}`

                return new Promise(resolve => {
                    if (input.length < 3) {
                        //$('#person-number').val('')
                        //$('#order-number').val('')
                        return resolve([])
                    }
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            resolve(data.client)
                        })
                })
            },
            renderResult: (result, props) => {
                let group = ''
                if (result.index % 3 === 0) {
                    group = '<li class="group">Group</li>'
                }
                return `
                ${group}
                <li ${props}>
                 <div class="h6" style="font-family: roboto_condensed_regular">
                    ${result.names}
                 </div>
                 <div class="wiki-snippet text-black">
                    ${result.typeDocument}: ${result.number_document}
                  </div>
                </li>
                `
            },

            getResultValue: result => result.names,
            onSubmit: result => {
                if (result) {
                    let client_id = result.id;
                    $('#client_id').val(client_id);
                    $('#client_name').val(result.names);
                    $('#person_address').val(result.last_address);

                } else {
                    toastr.warning('Seleccione un cliente valido', 'Error de llenado');
                    return false;
                }

            }
        });


        $('#btn-voucher-order').on('click', function (e) {

            /*let document_sender = $('#id-nro-document-sender');
            if ((document_sender.val() === '') && ($('#id_sender').val() === '') && ($('#id-client-sender').val()) === '') {
                toastr.warning('¡Elija un cliente porfavor!', 'Mensaje');
                document_sender.focus();
                return false;
            }*/

        });


        $('#sum-total').val('0.00');

        /*setTimeout(() => {
            $(".quicksearch").focus();
        }, 500);*/

        $("#id-nro-document-sender").attr('maxlength', 8);
        sessionStorage.setItem('document', '01')

        $('#id_client_name').select2({
            theme: 'bootstrap4',
        });

        let pu;
        let p;
        let perms;

        perms = "{{ perms.admin }}";
        // console.log(perms)

        sessionStorage.setItem('BillType', 'V');
        /*if ($("#radio2").is(':checked')) {
            $("#document_type_sender").attr('disabled', 'disabled');
            $("#id_client_name").removeAttr('disabled');
            $("#document_type_sender").find('option[value]').removeAttr('selected');
            $("#document_type_sender").find('option[value="0"]').attr('selected', 'selected');
            $("#id-nro-document-sender").attr('readonly', true);
            $("#document_type_sender").trigger('change');
        }*/

        $('#transaction_payment_type').change(function () {
            let type = $('#transaction_payment_type').val();
            if (type === 'E') {
                $('#cash').css('display', '');
                $('#deposit').css('display', 'none');
                $('#id_cash').trigger('change');
                $('#credit').css('display', 'none');
            } else if (type === 'D') {
                $('#deposit').css('display', '');
                $('#cash').css('display', 'none');
                $('#credit').css('display', 'none');
            } else if (type === 'C') {
                $('#credit').css('display', '');
                $('#cash').css('display', 'none');
                $('#deposit').css('display', 'none');
            } else if (type === '0') {
                $('#credit').css('display', 'none');
                $('#cash').css('display', 'none');
                $('#deposit').css('display', 'none');
            }
        });

        /*$(document).on('change', '#id-type-order', function () {
            let type = $('#id-type-order').val();
            if (type === 'T') {
                $('#search_quotation').css('display', '');
                $('#form_quotation').css('display', '');
                $('#form_quotation_row2').css('display', '');
            } else {
                $('#search_quotation').css('display', 'none');
                $('#form_quotation').css('display', 'none');
                $('#form_quotation_row2').css('display', 'none');
            }
        });*/
        $(document).on('click', '#btn-new-form', function () {
            location.reload();
        });

        /*function SearchQuotation() {
            let correlative = $('#id-search-quotation').val();
            $('#id-search-quotation').val('');
            $.ajax({
                url: '/sales/get_order_by_correlative/',
                async: true,
                dataType: 'json',
                type: 'GET',
                data: {'correlative': correlative},
                success: function (response) {
                    if (response.success) {
                        $('.update-order').removeClass('d-none');
                        $("#id_order_sale_quotation").val(response.order_id);
                        $("#id_order_sale_quotation_correlative").val(response.correlative);
                        $("#document_type_sender").val(response.document_type);
                        $("#document_type_sender").trigger('change');
                        $("#id_validity_date").val(response.validity_date);
                        $("#id_date_completion").val(response.date_completion);
                        $("#id_place_delivery").val(response.place_delivery);
                        $("#id_type_quotation").val(response.type_quotation);
                        $("#id_type_quotation").trigger('change');
                        $("#id_name_type_quotation").val(response.type_name_quotation);
                        $("#id_observation").val(response.observation);
                        $("#btn-voucher-order").prop("disabled", true);
                        $('.print-ticket-bill-quotation').css('display', 'flex');
                        $('#id-type-order').val('V');
                        $('#transaction_payment_type').val(response.transaction_payment_type)
                        let c = jQuery.Event("change");
                        c.which = 13;
                        c.keyCode = 13;
                        $("#transaction_payment_type").trigger(c);
                        $("#id-nro-document-sender").val(response.document_number);
                        let e = jQuery.Event("keypress");
                        e.which = 13;
                        e.keyCode = 13;
                        $("#id-nro-document-sender").trigger(e);
                        {#console.log(response.detail)#}
                        let Detail = response['detail'];
                        $('table#id-table-detail-order tbody#sales-details').empty();
                        Detail.forEach(
                            element =>
                                addOrderDetail(element.unit_id, element.product_id, element.quantity, element.price, element.unit_name, element.product_name, element.store, element.unit_min, element.id)
                        )
                    } else {
                        toastr.warning(response.message);
                    }
                },
                fail: function (response) {
                    toastr.error("error");
                }
            });
        }*/

        /*function showModalView(ruta, pk) {
            if (($('#id_client option:selected').val() == '0') && ($('#id_client_name option:selected').val() == '0')) {
                toastr.warning('¡Elija un cliente porfavor!', 'Mensaje!');
                $('#id_client').focus();
                return false;
            }
            if (hasRowDetails()) {
                // Comprobar si hay filas de un producto especifico
            }
            $('#add-modal').empty();
            $.ajax({
                url: '/sales/' + ruta + '/',
                async: true,
                dataType: 'json',
                type: 'GET',
                data: {'product': pk, 'distribution': $('#id_distribution').val()},
                success: function (response) {
                    {#$('#rates').html(response.grid);#}
                    $('#add-modal').html(response.form);
                    $('#add-modal').modal('show');
                },
                fail: function (response) {
                    toastr.error("error");
                }
            });
        }*/

        /*$(document).on('change', '#document_type_sender', function () {
            let _val = $(this).val();
            if (_val === '01') {
                $("#id-nro-document-sender").attr('maxlength', 8);
                sessionStorage.setItem('document', '01')
                $('#id-nro-document-sender').val('');
                $('#id_sender').val('');
                $('#id-address-line').css('display', 'none');
                $('#id_address').val('')
                {#$('#id_address_sender').val('');#}
            } else if (_val === '06') {
                $("#id-nro-document-sender").attr('maxlength', 11);
                sessionStorage.setItem('document', '06')
                $('#id-nro-document-sender').val('');
                $('#id_sender').val('');
                $('#id-address-line').css('display', '');
                $('#id_address').val('')
            } else if (_val === '04' || _val === '07' || _val === '00') {
                $("#id-nro-document-sender").attr('maxlength', 15);
                sessionStorage.setItem('document', '')
                $('#id_sender').val('');
                $('#id-nro-document-sender').val('');
                $('#id-address-line').css('display', 'none');
                $('#id_address').val('')
            }
        });*/

        /*$(document).on('change', '#id_client_name', function (e) {

            {#$('#id_client_name').trigger('change.select2');#}

            let client_id = $('#id_client_name option:selected').val();
            let client_name = $('#id_client_name option:selected').text();
            let address = $('#id_client_name option:selected').attr('address');
            let client_document = $('#id_client_name option:selected').attr('document-number');
            let client_document_type = $('#id_client_name option:selected').attr('document-type');
            $('#id-nro-document-sender').val(client_document);
            $('#document_type_sender').val(client_document_type)
            {#$("#document_type_sender").trigger('change');#}
            $("#id_sender").val(client_name);
            $("#id-client-sender").val(client_id);


            if (client_id !== 0) {
                $("#id_sender").val(client_name);
                $("#id-client-sender").val(client_id);
                $("#id_address").val(address);
                $('#document_type_sender').val(client_document_type);
                $('#id_client_name option:selected').attr('document-type');
                $('#id-nro-document-sender').val(client_document)
                $('#document_type_sender').val(client_document_type);
                {#$("#document_type_sender").trigger('change');#}
                $('#id-nro-document-sender').val(client_document);
            }
        });*/

        $('#document_number_client').keypress(function (e) {
            let document_number = $('#document_number_client');
            $('#client_name').val('');
            if (e.keyCode === 13) {
                e.preventDefault()
                $(this).trigger("enterKey");
                console.log(sessionStorage.getItem('document'))
                let _document_number = document_number.val();
                if ((sessionStorage.getItem('client-document') === '01') && (_document_number.length !== 8)) {
                    toastr.warning('¡Favor de completar los caracteres requeridos: 8 caracteres para DNI', 'Error de Datos');
                    return false;
                } else {
                    if ((sessionStorage.getItem('client-document') === '06') && (_document_number.length !== 11)) {
                        toastr.warning('¡Favor de completar los caracteres requeridos: 11 caracteres para RUC!', 'Error de Datos');
                        return false;
                    }
                }
                if (document_number.val() === '0') {
                    toastr.warning('¡Favor seleecionar un tipo de documento!', 'Error de Datos');
                    return false;
                }

                $('#loading-666').html(loader).show()

                $.ajax({
                    url: '/sales/get_name_business/',
                    async: true,
                    dataType: 'json', // for response
                    type: 'GET',
                    data: {
                        'nro_document': document_number.val(),
                        'type': $('#document_type_client').val()
                    },
                    contentType: 'application/json;charset=UTF-8',
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    success: function (response, textStatus, xhr) {
                        if (xhr.status === 200) {
                            toastr.success(response.message, '¡Bien hecho!');
                            $("#client_name").val(response.result);
                            $("#client_id").val(response.pk);
                            $("#client_address").val(response.address);
                            $('#loading-666').hide();
                        }
                    },
                    error: function (jqXhr, textStatus, xhr) {
                        if (jqXhr.status === 500) {
                            toastr.error(jqXhr.responseJSON.error, '¡Error de Consulta!');
                        } else {
                            if (textStatus === 'timeout') {
                                toastr.error('Failed from timeout', '¡Error de Consulta!');
                            } else {
                                console.log(" STATUS: " + xhr + " " + textStatus);
                            }
                        }
                        $('#loading-666').hide();
                    },
                });
                return false;
            }
        });

        /*$('#id_client, #id_client_name').on('select2:select', function (e) {
            $('#id_table_client').empty()
            let data = e.params.data;
            let search = data['id'];

            $.ajax({
                url: '/sales/get_client/',
                async: true,
                dataType: 'json',
                type: 'GET',
                data: {'pk': search},
                success: function (response) {
                    $('#client-name').val(response['client_names']);
                    $('#id_table_client').html(response.grid).parent('div').slideDown();
                },
                fail: function (response) {
                    toastr.error("error");
                }
            });

        });*/

        // sales_grid_tab1 - verifica si tiene filas
        function hasRowDetails() {
            var _response = false;
            if ($("#sales-details tr").length > 0) {
                _response = true;
            }
            return _response;
        }

        function calculateTotal() {
            var sum = 0;
            $('#sales-details tr.product td.item-total').each(function () {
                let total_detail = Number($(this).find('input.input-total-detail').val());
                {#console.log(total_detail)#}
                sum = sum + total_detail;
            });
            $('#sum-total').val(sum.toFixed(2));
        }


        /*function add_client_advancement($product, $_unit, $value) {

            if ($value === 0) {
                let _quantity = 0;
                $('table#id-table-detail-order tbody#sales-details tr').each(function () {
                    if ($(this).attr('product') == $product && $(this).attr('pu') == $_unit) {
                        _quantity = parseFloat($(this).find('td.item-quantity').text());
                        $('table.table-client-advancement tbody#details-client-advancement tr').each(function () {
                            if ($product == parseInt($(this).attr('product_final'))) {
                                let value_last = parseFloat($(this).find('td.quantity-client').text());
                                $(this).find('td.quantity-client').text((value_last + _quantity).toFixed(0));
                            }
                        })
                    }
                })
            } else {
                if ($value > 0) {
                    $('table.table-client-advancement tbody#details-client-advancement tr').each(function () {
                        if ($product == parseInt($(this).attr('product_final'))) {
                            let value_last = parseFloat($(this).find('td.quantity-client').text());
                            $(this).find('td.quantity-client').text((value_last + parseFloat($value)).toFixed(0));
                        }
                    })
                }
            }
        }*/

        /*function distribution_value(_product, _unit) {
            let param = 0;
            $('table#id-table-detail-order tbody#sales-details tr').each(function () {
                if ($(this).attr('product') == _product && $(this).attr('pu') == _unit) {
                    param = parseFloat($(this).find('td.item-quantity').text());
                    $('#tbl-sales-distribution-grid tbody.sales-distribution-detail tr').each(function () {
                        if (_product == parseInt($(this).attr('product'))) {
                            let value_last = parseFloat($(this).find('td.quantity-surplus').text());
                            $(this).find('td.quantity-surplus').text((value_last + param).toFixed(3));
                        }
                    })
                }
            })
        }*/

        function counterStrike() {
            var index = 1;
            $('#sales-details tr.product').each(function () {
                $(this).attr('i', index);
                $(this).children('td:first').text(index);
                index++;
            });

        }

        /*function create_voucher($type_doc, $print) {

            if (($('#id-nro-document-sender').val() === '') && ($('#id_sender').val() === '') && ($('#id-client-sender').val()) === '') {
                toastr.warning('¡Elija un cliente porfavor!', 'Mensaje');
                $('#id-nro-document-sender').focus();
                return false;
            }
            if ($type_doc === 'T') {
                createSales($type_doc, $print)
            } else {
                if ($type_doc === 'F') {
                    if ($("#document_type_sender").val() === '06') {
                        let _document_number = $('#id-nro-document-sender').val();
                        if (_document_number.length === 8) {
                            toastr.warning('¡La factura solo se registra con RUC!', 'Mensaje');
                            return false;
                        } else {
                            if (_document_number.length !== 11) {
                                toastr.warning('¡La factura solo se registra con RUC!!', 'Mensaje');
                                return false;
                            }
                        }
                    } else {
                        toastr.warning('El tipo de documento debe ser en RUC', 'Mensaje');
                        return false;
                    }
                    let r = confirm("¿Desea generar la factura?");
                    sessionStorage.setItem('BillType', 'F');
                    if (r === true) {
                        createSales($type_doc, $print);
                    }
                } else {
                    if ($type_doc === 'B') {
                        if ($("#document_type_sender").val() === '01') {
                            let _document_number = $('#id-nro-document-sender').val();
                            if (_document_number.length === 11) {
                                toastr.warning('¡La boleta solo se registra con DNI!', 'Mensaje');
                                return false;
                            } else {
                                if (_document_number.length !== 8) {
                                    toastr.warning('¡La boleta solo se registra con DNI!!', 'Mensaje');
                                    return false;
                                }
                            }
                        }
                        let r = confirm("¿Desea generar la boleta?");
                        sessionStorage.setItem('BillType', 'B');
                        if (r === true) {
                            createSales($type_doc, $print);
                        }
                    }
                }
            }
        }*/

        /*function createSales($type_doc, $print) {

            if ($('#id-type-order').val() === '0' || $('#id-type-order').val() === '') {
                toastr.warning('Seleccione el tipo de orden que desea realizar');
                return false;
            }
            if ($('#transaction_payment_type').val() === '0') {
                toastr.warning('¡Selecione el tipo de pago!', 'Mensaje');
                return false;
            }
            if ($('#transaction_payment_type').val() === 'E' && $('#id-type-order').val() === 'V') {
                if ($('#id_date').val() === '') {
                    toastr.error('No puede realizar ventas sin aperturar la caja', 'Mensaje');
                    return false;
                }
            }
            //Comprobar si selecciono serie
            if (($('#type').val() === 'E') && ($('#id_serie').val() === '0')) {
                toastr.warning('¡Favor de completar la serie!', 'Mensaje');
                $('#id_serie').focus();
                return false;
            }
            // Comprobar si hay filas en los detalles
            if (hasRowDetails() === false) {
                toastr.warning('¡Elija los productos..!', 'Mensaje');
                return false;
            }

            if ($('#id-type-order').val() === 'T') {
                if ($('#id_date_completion').val() === '' || $('#id_place_delivery').val() === '' || $('#id_type_quotation').val() === '0' || $('#id_name_type_quotation').val() === '' || $('#id_observation').val() === '') {
                    toastr.warning('Complete los campos de la cotización');
                    return false;
                }
            }

            if ($('#user_id').val() === '0') {
                toastr.warning('Seleccione el Usuario');
                return false;
            }
            if ($('#id-client-sender').val() === '') {
                toastr.warning('BUSQUE EL CLIENTE  O PRESIONE ENTER PARA BUSCARLO - ERROR DE LLENADO');
                return false;
            }

            let sales = {
                "Details": [],
                "credit": [],
                "Client": $('#id-client-sender').val(),
                "Address": $('#id_address').val(),
                "SaleTotal": $('#sum-total').val(),
                //"TransactionPaymentType": $('#transaction_payment_type').val(),
                //"Distribution": $('#id_distribution').val(),
                "Type": $type_doc,
                "order_type": 'V',
                "Serie": $('#id_serie').val(),
                "BillType": sessionStorage.BillType,
                "issueDate": $('#issue_date').val(),
                //"Demo": ($('#demo').is(':checked')) ? 1 : 0,
                "type_payment": $('#transaction_payment_type').val(),
                "cash": $('#id_cash').val(),
                "date_cash": $('#id_date').val(),
                "cash_deposit": $('#id_cash_deposit').val(),
                "cod_operation": $('#code-operation').val(),
                //"validity_date": $('#id_validity_date').val(),
                //"date_completion": $('#id_date_completion').val(),
                //"place_delivery": $('#id_place_delivery').val(),
                //"type_quotation": $('#id_type_quotation').val(),
                //"observation": $('#id_observation').val(),
                //"name_type_quotation": $('#id_name_type_quotation').val(),
                "order_sale_quotation": Number($('#id_order_sale_quotation').val()),
                "userID": $('#user_id').val(),
                "condition_days": $('#condition_days').val(),
                "CheckPrintSeries": $('#check_print_series').prop('checked')
            };

            // Recorre cada detalle de producto (son 2 arrays) each -> recorre

            $("#sales-details tr.product").each(function () {
                let _quantity = $(this).find("td.item-quantity input.input-quantity").val();
                if (_quantity === '' || _quantity <= 0) {
                    toastr.warning('Ingrese un valor valido para la cantidad');
                    return false
                }
                let _price = $(this).find("td.item-price input.input-price").val();
                if (_price === '' || _quantity <= 0) {
                    toastr.warning('Ingrese un valor valido para el precio');
                    return false
                }
                let productID = $(this).attr('product')
                let detailObj = {
                    "Product": productID,
                    "Unit": $(this).find("td.item-unit").attr('pu'),
                    "Quantity": parseFloat($(this).find("td.item-quantity input.input-quantity").val()).toFixed(2),
                    "Price": parseFloat($(this).find("td.item-price input.input-price").val()).toFixed(4),
                    "DetailTotal": parseFloat($(this).find("td.item-total input.input-total-detail").val()).toFixed(2),
                    "_commentary": $(this).find("td.item-product input.input-product-name").val(),
                    "Store": $(this).attr("store_p"),
                    "Serials": []
                };
                $(this).next('tr.product-serial').find(`tbody#details-serial-${productID} tr`).each(function () {
                    let serialObj = {
                        "Serial": $(this).find('td.item-serial input.serial').val()
                    }
                    detailObj.Serials.push(serialObj);
                });
                sales.Details.push(detailObj);
            });
            $("#credit_details tr").each(function () {
                let creditObj = {
                    date: $(this).find("td.item-date-credit input.input-date").val(),
                    amount: $(this).find("td.item-amount-credit input.input-amount").val(),
                };
                sales.credit.push(creditObj);
            });

            $("#save-order").slideUp("fast");
            $("#btn-invoice-ticket").slideUp("fast");
            $("#btn-bill-ticket").slideUp("fast");
            $("#btn-invoice-a4").slideUp("fast");
            $("#btn-bill-a4").slideUp("fast");

            $(".menu-sales").addClass('d-none');

            //console.log(sales)
            $.ajax({
                url: '/sales/create_order_detail/',
                async: true,
                dataType: 'json', // for response
                type: 'GET',
                data: {'sales': JSON.stringify(sales)},
                contentType: 'application/json;charset=UTF-8',
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        if (response.msg_sunat !== undefined) {
                            toastr.success(response.message + response.msg_sunat, '¡Mensaje!');
                        } else {
                            toastr.success(response.message, '¡Mensaje!');
                        }

                        if ($type_doc === 'T' && $print === 'T') {
                            window.open("/sales/print_ticket_order_sales/" + response.id_sales + "/" + '0' + "/", '_blank');
                        } else if ($type_doc === 'F' || $type_doc === 'B') {
                            if ($print === 'T') {
                                window.open("/sales/print_ticket_order_sales/" + response.id_sales + "/" + '1' + "/", '_blank');
                            } else if ($print === 'A4') {
                                window.location.href = "/sales/print_order_bill/" + response.id_sales + "/" + response.check_print_series + "/"
                            }
                        }
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    toastr.error(jqXhr.responseJSON.error, '¡ERROR DE SUNAT!');
                    $(".menu-sales").removeClass('d-none');
                    $("#save-order").slideDown("fast");
                    $("#btn-invoice-ticket").slideDown("fast");
                    $("#btn-bill-ticket").slideDown("fast");
                    $("#btn-invoice-a4").slideDown("fast");
                    $("#btn-bill-a4").slideDown("fast");
                }
            });

        }*/

        $('#order-form').submit(function (e) {

            e.preventDefault();

            let _transaction_payment_type = $('#transaction_payment_type');

            if ($('#user_id').val() === '0') {
                toastr.warning('SELECCIONE EL USUARIO', 'Mensaje');
                return false;
            }

            if ($('#client_id').val() === '') {
                toastr.warning('SELECCIONE UN CLIENTE O BUSQUELO POR NUMERO DE DOCUMENTO', 'Error de Llenado');
                return false;
            }
            if ($('#type_bill_document').val() === null) {
                toastr.warning('Seleccionee el Tipo de Documento a Emitir', 'Error de Llenado');
                return false;
            }
            if (_transaction_payment_type.val() === '0') {
                toastr.warning('SELECIONE EL TIPO DE PAGO', 'Mensaje');
                return false;
            }
            /*if (_transaction_payment_type.val() === 'E') {
                if ($('#id_date').val() === '') {
                    toastr.error('No puede realizar ventas sin aperturar la caja', 'Mensaje');
                    return false;
                }
            }*/
            if (_transaction_payment_type.val() === 'C') {
                if (hasRowDetailsCredits() === false) {
                    toastr.warning('Registre las cuotas de pago y la condición de pago', 'Mensaje');
                    return false
                }
            }
            if (hasRowDetails() === false) {
                toastr.warning('¡SELECIONE LOS PRODUCTOS!', 'Mensaje');
                return false;
            }

            let detailOrder = []
            let creditDict = []

            $("#sales-details tr.product").each(function () {
                let _quantity = $(this).find("td.item-quantity input.input-quantity").val();
                if (_quantity === '' || _quantity <= 0) {
                    toastr.warning('INGRESE UN VALOR VALIDO PARA LA CANTIDAD');
                    return false
                }
                let _price = $(this).find("td.item-price input.input-price").val();
                if (_price === '' || _quantity <= 0) {
                    toastr.warning('INGRESE UN VALOR VALIDO PARA EL PRECIO');
                    return false
                }
                let productID = $(this).attr('product')
                let detailObj = {
                    product: $(this).attr('product'),
                    unit: $(this).find("td.item-unit").attr('pu'),
                    quantity: parseFloat($(this).find("td.item-quantity input.input-quantity").val()).toFixed(2),
                    price: parseFloat($(this).find("td.item-price input.input-price").val()).toFixed(6),
                    commentary: $(this).find("td.item-product input.input-product-name").val(),
                    detailTotal: parseFloat($(this).find("td.item-total input.input-total-detail").val()).toFixed(6),
                    store: $(this).attr("store_p"),
                    serials: []
                };
                $(this).next('tr.product-serial').find(`tbody#details-serial-${productID} tr`).each(function () {
                    let serialObj = {
                        "Serial": $(this).find('td.item-serial input.serial').val()
                    }
                    detailObj.serials.push(serialObj);
                });
                detailOrder.push(detailObj);
            });
            $("#credit_details tr").each(function () {
                let creditObj = {
                    date: $(this).find("td.item-date-credit input.input-date").val(),
                    amount: $(this).find("td.item-amount-credit input.input-amount").val(),
                };
                creditDict.push(creditObj);
            });

            let data = new FormData($('#order-form').get(0));
            data.append('detail', JSON.stringify(detailOrder));
            data.append('credit', JSON.stringify(creditDict));
            //console.log(detailOrder)
            //console.log(creditDict)
            //$('#save-order').prop('disabled', true)
            $('#loading-bill').html(loader2).show();
            $.ajax({
                url: '/sales/save_order/',
                async: true,
                dataType: 'json', // for response
                type: 'POST',
                cache: false,
                processData: false,
                data: data,
                contentType: false,
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        if (response.msg_sunat !== undefined) {
                            toastr.success(response.message + response.msg_sunat, '¡Mensaje!');
                        } else {
                            toastr.success(response.message, '¡Mensaje!');
                        }
                        if (response.voucher_type === 'T' && response.format_pdf === 'T') {
                            window.open("/sales/print_ticket_order_sales/" + response.id_sales + "/" + '0' + "/", '_blank');
                        } else if (response.voucher_type === 'F' || response.voucher_type === 'B') {
                            if (response.format_pdf === 'T') {
                                window.open("/sales/print_ticket_order_sales/" + response.id_sales + "/" + '1' + "/", '_blank');
                            } else if (response.format_pdf === 'A4') {
                                window.location.href = "/sales/print_order_bill/" + response.id_sales + "/" + response.check_print_series + "/"
                            }
                        }
                        $('#loading-bill').hide();
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    toastr.error(jqXhr.responseJSON.error, '¡ERROR!');
                    $('#loading-bill').hide();
                }
            });
        });

        /*function clearForm() {

            $('#client-name').val('');
            $('#id-client-sender').val('');
            $('#id-nro-document-sender').val('');
            $('#id_sender').val('');
            $('#id_client').val('0').trigger('change')
            $("#sales-details").empty();
            $('#sum-total').val('');
            $("#code-operation").empty();
            $(".quicksearch").empty();
            $("#id_distribution").val('');
            $("#id-nro-document-sender").attr('maxlength', 8);
            sessionStorage.setItem('document', '01')
        }*/


        $(".invoice").click(function () {

            // Comprobar si hay un cliente seleccionado
            if (($('#id_client option:selected').val() == '0') && ($('#id_client_name option:selected').val() == '0')) {
                toastr.warning('¡Elija un cliente porfavor!', 'Error de Llenado!');
                $('#id_client').focus();
                return false;
            }
            //Comprobar si selecciono serie
            if (($('#type').val() == 'E') && ($('#id_serie').val() == '0')) {
                toastr.warning('¡Favor de completar la serie!', 'Error de Llenado!');
                $('#id_serie').focus();
            }
            // Comprobar si hay filas en los detalles
            if (hasRowDetails() == false) {
                toastr.warning('¡Elija los productos..!', 'Error de Llenado!');
                return false;
            }
            if ($("#radio1").is(':checked')) {

                let _document_number = $('#id_client option:selected').attr('document-number');

                if (_document_number.length === 8) {
                    toastr.warning('¡La factura solo se registra con RUC!', 'Error de Llenado!');
                    return false;
                } else {
                    if (_document_number.length !== 11) {
                        toastr.warning('¡La factura solo se registra con RUC!!', 'Error de Llenado!');
                        return false;
                    }
                }
            } else {
                if ($("#radio2").is(':checked')) {
                    let _document_number_name = $('#id_client_name option:selected').attr('document-number');

                    if (_document_number_name.length === 8) {
                        toastr.warning('¡La factura solo se registra con RUC!', 'Error de Llenado!');
                        return false;
                    } else {
                        if (_document_number_name.length !== 11) {
                            toastr.warning('¡La factura solo se registra con RUC!', 'Error de Llenado!');
                            return false;
                        }
                    }
                }
            }

            let r = confirm("¿Desea generar la factura?");
            sessionStorage.setItem('BillType', 'F');
            if (r === true) {

                createSales();
            }
        });
        $(".receipt").click(function () {

            // Comprobar si hay un cliente seleccionado
            if (($('#id_client option:selected').val() == '0') && ($('#id_client_name option:selected').val() == '0')) {
                toastr.warning('¡Elija un cliente porfavor!', 'Error de LLenado!');
                $('#id_client').focus();
                return false;
            }
            //Comprobar si selecciono serie
            if (($('#type').val() == 'E') && ($('#id_serie').val() == '0')) {
                toastr.warning('¡Favor de completar la serie!', 'Error de LLenado!');
                $('#id_serie').focus();
            }
            // Comprobar si hay filas en los detalles
            if (hasRowDetails() == false) {
                toastr.warning('¡Elija los productos..!', 'Error de LLenado!');
                return false;
            }

            if ($("#radio1").is(':checked')) {

                let _document_number = $('#id_client option:selected').attr('document-number');

                if (_document_number.length === 11) {
                    toastr.warning('¡La boleta solo se registra con DNI!', 'Error de Llenado!');
                    return false;
                } else {
                    if (_document_number.length !== 8) {
                        toastr.warning('¡La boleta solo se registra con DNI!!', 'Error de Llenado!');
                        return false;
                    }
                }
            } else {
                if ($("#radio2").is(':checked')) {
                    let _document_number_name = $('#id_client_name option:selected').attr('document-number');

                    if (_document_number_name.length === 11) {
                        toastr.warning('¡La boleta solo se registra con DNI!', 'Error de Llenado!');
                        return false;
                    } else {
                        if (_document_number_name.length !== 8) {
                            toastr.warning('¡La boleta solo se registra con DNI!!', 'Error de Llenado!');
                            return false;
                        }
                    }
                }
            }
            let r = confirm("¿Desea generar la boleta de venta?");
            sessionStorage.setItem('BillType', 'B');
            if (r === true) {

                createSales();
            }
        });


        /*$("#radio1,#radio2").click(function () {
            if ($("#radio1").is(':checked')) {
                $("#id_client_name").attr('disabled', 'disabled');
                $("#document_type_sender").removeAttr('disabled');
                $("#id-nro-document-sender").attr('readonly', false);
                $("#id_client_name").find('option[value]').removeAttr('selected');
                $("#id_client_name").find('option[value="0"]').attr('selected', 'selected');
                $("#id_client_name").trigger('change');
                $('#document_type_sender').val(0);
                $("#id_sender").val('');
                $("#id-nro-document-sender").val('');
                $("#id_address").val('');
                $(".client-table").val('');
                $(".client-table").attr('placeholder', '')
                $(".client-table").attr('disabled', 'disabled');

            } else if ($("#radio2").is(':checked')) {
                $("#document_type_sender").attr('disabled', 'disabled');
                $("#id_client_name").removeAttr('disabled');
                $("#document_type_sender").find('option[value]').removeAttr('selected');
                $("#document_type_sender").find('option[value="0"]').attr('selected', 'selected');
                $("#id_sender").val('');
                $("#id_address").val('');
                $("#document_type_sender").trigger('change');
                $("#id-nro-document-sender").val('');
                $("#id-nro-document-sender").attr('readonly', true);
                $(".client-table").attr('placeholder', 'INGRESE CLIENTE Y PRESIONE ENTER...')
                $(".client-table").removeAttr('disabled');
            }
        });*/

        /*function Client_Advancement($product, $quantity) {
            let a = false;
            $('table.table-client-advancement tbody#details-client-advancement tr').each(function () {

                if ($product == $(this).attr('product_final')) {
                    let quantity_b = parseFloat($(this).find('td.quantity-client').text());
                    if ((quantity_b - parseFloat($quantity)) >= 0) {
                        $(this).find('td.quantity-client').text((Difference(quantity_b, parseFloat($quantity))).toFixed(0));
                        a = true;
                    } else {
                        a = false;
                    }
                }
            })
            return a;
        }*/

        /*function Difference(Valor1, Valor2) {
            let S = parseFloat(Valor1 - Valor2);
            return S;
        }*/

        /*$('#tbl-sales-distribution-grid tbody.sales-distribution-detail tr td').each(function () {
            let _str = $(this).text();
            _str = _str.replace(',', '.');
            $(this).text(_str);
        });*/


        /*if ($("#type").length) {
            if ($("#type").val() == 'E') {
                $("#save-order").hide()
            } else {
            }
        }*/

        /*function printPdf($url) {
            let link = document.createElement('a');
            link.href = $url;
            link.download = 'file.pdf';
            link.dispatchEvent(new MouseEvent('click'));
        }*/

        $("#id_cash").change(function () {

            $("#id_date").val('');

            if ($("#id_cash").val() !== '0') {

                $.ajax({
                    url: '/accounting/get_cash_date/',
                    async: true,
                    dataType: 'json', // for response
                    type: 'GET',
                    data: {'cash_id': $("#id_cash").val()},
                    contentType: 'application/json;charset=UTF-8',
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    success: function (response, textStatus, xhr) {
                        if (xhr.status === 200) {
                            toastr.success(response.message, 'Mensaje');
                            $("#id_date").val(response.cash_date);
                        }
                    },
                    error: function (jqXhr, textStatus, xhr) {
                        if (jqXhr.status === 500) {
                            toastr.warning(jqXhr.responseJSON.error, 'Mensaje');
                        } else {
                            if (textStatus === 'timeout') {
                                toastr.error('Failed from timeout', 'Mensaje');
                            } else {
                                console.log(" STATUS: " + xhr + " " + textStatus);
                            }
                        }
                    }
                });
            }
        });
        /*$('#id_address').keypress(function (e) {

            if (e.keyCode === 13) {
                e.preventDefault()
                $(this).trigger("enterKey");
                if ($('#id-client-sender').val() === '') {
                    toastr.warning('¡Problemas en la seleccion del cliente', 'Direccion');
                    return false;
                }
                let _address_ = $('#id_address').val();
                if (_address_.length === 0) {
                    toastr.warning('¡Favor de completar la direccion', 'Direccion');
                    return false;
                }
                $.ajax({
                    url: '/sales/update_address/',
                    async: true,
                    dataType: 'json', // for response
                    type: 'GET',
                    data: {
                        'pk_': $('#id-client-sender').val(),
                        'address_': $('#id_address').val()
                    },
                    success: function (response) {
                        toastr.success(response.message, 'Mensaje')
                    },
                    fail: function (response) {
                        toastr.error('Problemas en la actualizacion', 'Mensaje')
                    }
                });
                return false;
            }
        });*/


        $(document).on('click', 'table#product-data-grid tbody tr td table.table-prices tbody tr td.prices-list div button', async function () {

            let tr = $(this).closest('tr');
            let _tr_product = $(this).closest('tbody').closest('td').parent('tr');
            let _type_search = _tr_product.attr('type_search');
            let product_serial = _tr_product.find('td.td-table-stock table.table-stock-headquarters tbody tr').attr('product_serial');

            let price = parseFloat($(this).attr('ip'));
            let purchase_price = parseFloat(tr.attr('price_purchase'));
            let unit_id = tr.attr('unit');
            let name_unit = tr.attr('unitname');
            let product_id = tr.attr('product');

            let name_product = tr.attr('productname');
            let quantity_minim = parseFloat(tr.attr('quantity_minum'));
            let quantity = parseFloat(tr.find('td.quantity-sales-price input.quantity-select').val());
            let stock = parseInt(tr.parent('tbody').closest('td').parent('tr').find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary[store_="V"] td.item-stock').text());

            let store_id = tr.parent('tbody').parents('table.table-prices').parent('td').parent('tr').find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary').attr('store_id');

            let $serialElement = tr.closest('table').parent('td').parent('tr').find('td.item-product span.serial');
            let serial = '';

            if ($serialElement.length > 0) {
                serial = $serialElement.text()
            } else {
                let product = product_dict.find(p => p.id === parseInt(product_id));
                if (product) {
                    let productStore = product.product_store.find(ps => ps.id === parseInt(store_id));
                    if (productStore) {
                        serial = productStore.serial
                            .filter(ps => ps.status === 'P')
                            .map(ps => ps.serial);
                    }
                }
            }

            let quantity_input = tr.find('td.quantity-sales-price input.quantity-select');

            if (isNaN(quantity)) {
                toastr.warning('INGRESE LA CANTIDAD DEL PRODUCTO O SELECCIONE SERIES');
                quantity_input.val('')
                return false
            }
            if (quantity === '' || quantity === 0) {
                toastr.warning('INGRESE LA CANTIDAD DEL PRODUCTO O SELECCIONE SERIES');
                quantity_input.val('')
                return false
            }
            if (quantity < 0) {
                toastr.warning('LA CANTIDAD DEBE SER UN VALOR POSITIVO');
                quantity_input.val('')
                return false
            }

            if (product_serial === 'false') {
                if ($("#sales-details tr[product=" + product_id + "][pu=" + unit_id + "]").length) {
                    let $msg = 'EL PRODUCTO CON ESTE TIPO DE UNIDAD YA SE ENCUENTRA EN EL REGISTRO.';
                    toastr.warning($msg, 'Mensaje');
                    quantity_input.val('')
                    return false;
                }
                let _flag_stock = true

                if (name_unit !== 'ZZ') {
                    _flag_stock = await check_stock(quantity, product_id)
                }
                if (_flag_stock === true) {
                    addOrderDetail(unit_id, product_id, quantity, price, name_unit, unescape(name_product), store_id, quantity_minim, serial, product_serial, purchase_price);
                    tr.parent('tbody').parents('table.table-prices').parent('td').parent('tr').find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary[store_="V"] td.item-stock button.btn-stock').text(stock - quantity * quantity_minim);
                } else {
                    toastr.warning('STOCK INSUFICIENTE EN ALMACEN');
                }

            } else if (product_serial === 'true') {
                if ($("#sales-details tr[product=" + product_id + "][pu=" + unit_id + "]").length) {
                    let $msg = 'EL PRODUCTO CON EL TIPO DE UNIDAD YA SE ENCUENTRA EN EL REGISTRO.';
                    toastr.warning($msg, 'Mensaje');
                    return false;
                }
                let td_prices = tr.find('td.prices-list');
                addOrderDetailSerial(unit_id, product_id, quantity, price, name_unit, unescape(name_product), store_id, quantity_minim, serial, product_serial);
                td_prices.find('div.row button').each(function () {
                    $(this).attr('disabled', true);
                });
            } else {
                addOrderDetail(unit_id, product_id, quantity, price, name_unit, unescape(name_product), store_id, quantity_minim, serial, product_serial);
            }
            //quantity_input.val('');

        });

        function deleteItem($product, $unit, $product_serial, $product_store) {
            let rows = $('#sales-details').find("tr[product=" + $product + "][pu=" + $unit + "]");
            let _row = $('table#product-data-grid tbody tr[product=' + $product + ']');
            let quantity_delete = parseInt(rows.find('td.item-quantity input.input-quantity').val());
            let quantity_min = parseFloat(rows.find('td.item-unit').attr('unit_min'));
            let old_stock = parseInt(_row.find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary[store_="V"] td.item-stock').text());
            let new_stock = old_stock + (quantity_delete * quantity_min)
            let btn_stock = _row.find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary[store_="V"] td.item-stock button.btn-stock');
            if ($product_serial === false) {
                btn_stock.text(new_stock);

            } else if ($product_serial === true) {
                let product = product_dict.find(p => p.id === parseInt($product));
                let td_quantity = _row.find('td.item-prices table.table-prices tbody td.quantity-sales-price');
                let td_prices = _row.find('td.item-prices table.table-prices tbody td.prices-list');

                if (product) {
                    let productStore = product.product_store.find(ps => ps.id === parseInt($product_store));
                    if (productStore) {
                        productStore.serial.forEach(serial => {
                            serial.status = 'C';
                        });
                    }
                    //let countStatusC = productStore.serial.filter(serial => serial.status === 'C').length;
                    btn_stock.text(new_stock);
                    //console.log(product_dict)
                }
                let _next_row = rows.next('tr.product-serial')
                _next_row.remove()

                td_prices.find('div.row button').each(function () {
                    $(this).attr('disabled', false);
                });
                td_quantity.find('input.quantity-select').val('')

            }
            rows.remove();
            calculateTotal();
            counterStrike();
        }

        function addOrderDetail(a, b, c, d, e, f, g, h, serial, _product_serial, price_purchase) {

            let _unit_id = a
            let _product_id = b
            let _quantity = parseFloat(c)
            let _price = parseFloat(d)
            let _total = _quantity * _price
            let _unit = e
            let _product_name = escapeHtml(f)
            let _product_store = g
            let _quantity_minim = parseFloat(h)
            $('#sales-details').append(
                '<tr detail_id="' + 'NaN' + '" product="' + _product_id + '" store_p="' + _product_store + '" pu="' + _unit_id + '" price_p="'+ price_purchase +'" class="text-uppercase small text-center product" style="font-size: 14px;">' +
                '<td class="align-middle">' + '</td>' +
                '<td class="align-middle text-left item-product">' + '<input type="text" class="form-control form-control-sm input-product-name" value="' + _product_name + '">' + '</td>' +
                '<td class="align-middle item-quantity">' + '<input type="text" class="form-control form-control-sm text-right input-quantity" disabled value="' + _quantity.toFixed(2) + '">' + '</td>' +
                '<td class="align-middle item-unit" pu="' + _unit_id + '" unit_min="' + _quantity_minim + '">' + _unit + '</td>' +
                '<td class="align-middle item-price">' + '<input type="text" class="form-control form-control-sm text-right input-price" value="' + _price.toFixed(2) + '">' + '</td>' +
                '<td class="align-middle item-total">' + '<input type="text" class="form-control form-control-sm text-right input-total-detail" value="' + _total.toFixed(2) + '">' + '</td>' +
                '<td>' + '<button type="button" onclick="deleteItem(' + _product_id + ',' + _unit_id + ',' + _product_serial + ',' + _product_store + ')" class="btn btn-danger btn-sm">' +
                '<i class="fa fa-trash"></i></button>' + '</td>' +
                '</tr>' +
                '<tr class="product-serial" product="' + _product_id + '">' + '</tr>'
            );
            calculateTotal();
            counterStrike();
        }

        function addOrderDetailSerial(a, b, c, d, e, f, g, h, serial, _product_serial) {
            let _unit_id = a
            let _product_id = b
            let _quantity = parseFloat(c)
            let _price = parseFloat(d)
            let _total = _quantity * _price
            let _unit = e
            let _product_name = escapeHtml(f)
            let _product_store = g
            let _quantity_minim = parseFloat(h)

            let serials = '<tr>' +
                '<td class="text-right align-middle item-serial">' +
                '<input type="text" class="form-control text-center serial" readonly value="' + serial + '" aria-label="" aria-describedby="basic-addon1">' +
                '</td>' +
                '</tr>';
            if (Array.isArray(serial)) {
                serials = '';
                for (let i = 0; i < serial.length; i++) {
                    serials += '<tr>' +
                        '<td class="text-right align-middle item-serial">' +
                        '<input type="text" class="form-control text-center serial" readonly value="' + serial[i] + '" aria-label="" aria-describedby="basic-addon1">' +
                        '</td>' +
                        '</tr>';
                }
            }

            $('#sales-details').append(
                '<tr detail_id="' + 'NaN' + '" product="' + _product_id + '" store_p="' + _product_store + '" pu="' + _unit_id + '" class="text-uppercase small text-center product" style="font-size: 14px;">' +
                '<td class="align-middle">' + '</td>' +
                '<td class="align-middle text-left item-product">' + '<input type="text" class="form-control form-control-sm input-product-name" value="' + _product_name + '">' + '</td>' +
                '<td class="align-middle item-quantity">' + '<input type="text" class="form-control form-control-sm text-right input-quantity" disabled value="' + _quantity.toFixed(2) + '">' + '</td>' +
                '<td class="align-middle item-unit" pu="' + _unit_id + '" unit_min="' + _quantity_minim + '">' + _unit + '</td>' +
                '<td class="align-middle item-price">' + '<input type="text" class="form-control form-control-sm text-right input-price" value="' + _price.toFixed(2) + '">' + '</td>' +
                '<td class="align-middle item-total">' + '<input type="text" class="form-control form-control-sm text-right input-total-detail" value="' + _total.toFixed(2) + '">' + '</td>' +
                '<td>' + '<button type="button" onclick="deleteItem(' + _product_id + ',' + _unit_id + ',' + _product_serial + ',' + _product_store + ')" class="btn btn-danger btn-sm">' +
                '<i class="fa fa-trash"></i></button>' + '</td>' +
                '</tr>' +
                '<tr class="product-serial" product="' + _product_id + '">' +
                '<td class="text-right align-middle" colspan="1"></td>' +
                '<td class="text-right align-middle serial-column">' +
                '<div id="accordion">' +
                '<div class="card">' +
                '<div class="card-header p-0" id="heading-' + _product_id + '">' +
                '<h5 class="mb-0 text-center">' +
                '<button class="btn btn-link collapsed text-dark roboto-condensed-regular font-weight-bold p-0"' +
                'data-toggle="collapse" style="font-size: 11px"' +
                'data-target="#collapse-' + _product_id + '" aria-expanded="false" aria-controls="collapse-' + _product_id + '">' +
                'Seriales<i class="fas fa-sort-down"></i>' +
                '</button>' +
                '</h5>' +
                '</div>' +
                '<div id="collapse-' + _product_id + '" class="collapse" aria-labelledby="heading-' + _product_id + '" data-parent="#accordion">' +
                '<div class="card-body p-0">' +
                '<table class="table table-sm align-content-center table-bordered mb-0">' +
                '<tbody id="details-serial-' + _product_id + '"">' +
                serials +
                '</tbody>' +
                '</table>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</td>' +
                '</tr>'
            );
            $('#collapse-' + _product_id).collapse('show');
            calculateTotal();
            counterStrike();
        }

        function escapeHtml(text) {
            let map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };

            return text.replace(/[&<>"']/g, function (m) {
                return map[m];
            });
        }

        /*$('#id-family').change(function () {
            let _search = $(this).val();
            $('#product_list_sales').empty();
            if (_search === '0') {
                $('div#loader-product').css('display', 'none');
                $('#product_list_sales').text('Listado de productos')
                return false
            } else {
                $('div#loader-product').css('display', '');
                $.ajax({
                    url: '/sales/get_product_sales_grid/',
                    async: true,
                    dataType: 'json',
                    type: 'GET',
                    data: {'pk': _search},
                    success: function (response) {
                        $('#product_list_sales').html(response.grid).slideDown();
                        $('div#loader-product').css('display', 'none');
                    },
                });
            }
        });*/
        $(document).on('keypress', '#custom-search-product', function (e) {

            let type_search = $('#type_search').val()

            $('#product_list_sales').empty();
            $('#custom-search-barcode').val(' ')

            if (e.keyCode === 13) {

                e.preventDefault()

                $(this).trigger("enterKey");

                let _product_name = $(this).val().trim();

                if (_product_name.length === 0) {
                    toastr.warning('¡Favor de ingresar una busqueda', 'Error de Datos');
                    return false;
                }
                getProductsByType(_product_name, type_search)

            }
        });

        $(document).on('keypress', '#custom-search-barcode', function (e) {

            let type_search = $('#type_search').val()

            $('#product_list_sales').empty();
            $('#custom-search-product').val(' ');

            if (e.keyCode === 13) {

                e.preventDefault()

                $(this).trigger("enterKey");

                let _barcode = $(this).val().trim();

                if (_barcode.length === 0) {
                    toastr.warning('¡Favor de ingresar un codigo de barras', 'Error de Datos');
                    return false;
                }
                getProductsByType(_barcode, type_search)

            }
        });

        let product_dict = {}

        function getProductsByType($value, $type) {

            $('div#loader-product').css('display', '');
            $.ajax({
                url: '/sales/get_product_sales_grid_new/',
                async: true,
                dataType: 'json', // for response
                type: 'GET',
                data: {
                    'value': $value,
                    'type': $type
                },
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        //toastr.success(response.message, '¡Bien hecho!');
                        product_dict = response.product_set
                        $('#product_list_sales').html(response.grid).slideDown();
                        $('div#loader-product').css('display', 'none');
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    if (jqXhr.status === 500) {
                        toastr.error(jqXhr.responseJSON.error, '¡Error de Consulta!');
                    } else {
                        if (textStatus === 'timeout') {
                            toastr.error('Failed from timeout', '¡Error de Consulta!');
                        } else {
                            console.log(" STATUS: " + xhr + " " + textStatus);
                        }
                    }
                }
            });
        }
        $(document).on('blur', '#sales-details tr td.item-price input.input-price', function (e) {
            let val = Number($(this).val());
            let row = $(this).parent('td.item-price').parent('tr');
            let price_purchase = Number(row.attr('price_p'));
            let product_id = row.attr('product');
            validatePrice(val, price_purchase, product_id)
            //$(this).val('');
            //$(this).focus();
            /*if (val < price_purchase){
                toastr.error('El precio de venta no puede ser menor al precio de compra', '¡Error de escritura!');
                $(this).val('');
                $(this).focus();
                calculateTotal();
            }*/
        });

        function validatePrice(val, price_purchase, product_id) {
            let rows = $('#sales-details').find("tr[product=" + product_id + "]");
            if (val < price_purchase){
                toastr.error('El precio de venta no puede ser menor al precio de compra', '¡Error de escritura!');
                let _input = rows.find('td.item-price input.input-price');
                _input.val('');
                //_input.focus();
                calculateTotal();
            }
        }

        $(document).on('keyup', '#sales-details tr td.item-price input.input-price', function (e) {
            let val = Number($(this).val());
            let row = $(this).parent('td.item-price').parent('tr');
            let quantity = Number(row.find('td.item-quantity input.input-quantity').val());
            {#console.log('quantity',quantity)#}
            {#console.log('val',val)#}
            if (isNaN(val)) {
                $(this).val('')
            } else {
                let total_detail = quantity * val
                if (val !== '') {
                    row.find('td.item-total input.input-total-detail').val((total_detail).toFixed(2))
                    calculateTotal();
                }
            }
        });
        $(document).on('keyup', '#sales-details tr td.item-quantity input.input-quantity', function (e) {
            let val = Number($(this).val());
            let row = $(this).parent('td.item-quantity').parent('tr');
            let price = Number(row.find('td.item-price input.input-price').val());
            if (isNaN(val)) {
                $(this).val('')
            } else {
                if (val !== '') {
                    row.find('td.item-total input.input-total-detail').val((price * val).toFixed(2))
                    calculateTotal();
                }
            }
        });

        $(document).on('keyup', '#sales-details tr td.item-total input.input-total-detail', function (e) {
            let val = Number($(this).val());
            {#console.log('total', val)#}
            let row = $(this).parent('td.item-total').parent('tr');
            let quantity = Number(row.find('td.item-quantity input.input-quantity').val()).toFixed(6);
            let price = Number(row.find('td.item-price input.input-price').val()).toFixed(6);
            {#console.log('quantity', quantity)#}

            let price_unit = val / quantity
            {#console.log('price_unit', price_unit)#}
            row.find('td.item-price input.input-price').val((price_unit).toFixed(6))
            calculateTotal();
            let price_sale = Number(row.find('td.item-price input.input-price').val());
            let price_purchase = Number(row.attr('price_p'));
            let product_id = row.attr('product');
            validatePrice(price_sale, price_purchase, product_id)
        });


        $(document).on('change', '#document_type_client', async function () {
            let _val = $(this).val();
            console.log(_val)
            if (_val === '01') {
                $("#document_number_client").attr('maxlength', 8);
                sessionStorage.setItem('client-document', '01')
                $('#document_number_client').val('');
                {#$('#id_sender').val('');#}
                {#$('#id-address-line').css('display', 'none');#}
                {#$('#id_address').val('')#}
                {#$('#id_address_sender').val('');#}
            } else if (_val === '06') {
                $("#document_number_client").attr('maxlength', 11);
                sessionStorage.setItem('client-document', '06')
                $('#document_number_client').val('');
                {#$('#id_sender').val('');#}
                {#$('#id-address-line').css('display', '');#}
                {#$('#id_address').val('')#}
            } else if (_val === '00') {
                $("#document_number_client").attr('maxlength', 15);
                sessionStorage.setItem('client-document', '')
                let new_n_order = await get_last_number_others();
                {#$('#id_sender').val('');#}
                $('#document_number_client').val(new_n_order);
                {#$('#id-address-line').css('display', 'none');#}
                {#$('#id_address').val('')#}
            }
        });

        /*$('#id_district').select2({
            theme: 'bootstrap4',
        });*/

        $("#document_number_client").attr('maxlength', 8);
        sessionStorage.setItem('client-document', '01')

        $(document).on('click', '#save-new-client', function (e) {

            e.preventDefault()

            let _document_type = $('#document_type_client').val();
            let _document_number = $('#document_number_client').val();
            let _names = $('#client-names').val();
            let _phone = $('#client-phone').val();
            let _email = $('#client-email').val();
            let _address = $('#client-address').val();
            let _district = $('#id_district').val();
            let _reference = $('#client-reference').val();

            if (sessionStorage.getItem('client-document') === '01') {

                if (_document_number.length !== 8) {
                    toastr.warning('¡Favor de completar los caracteres requeridos: 8 caracteres para DNI', 'Error de Datos');
                    return false;
                }
                if (_names.length === 0) {
                    toastr.warning('¡Favor de completar los Nombres', 'Error de Datos!');
                    return false;
                }
            } else {
                if (sessionStorage.getItem('client-document') === '06') {
                    if (_document_number.length !== 11) {
                        toastr.warning('¡Favor de completar los caracteres requeridos: 11 caracteres para RUC!', 'Error de Datos');
                        return false;
                    }
                    if (_names.length === 0) {
                        toastr.warning('¡Favor de completar la Razon Social', 'Error de Datos!');
                        return false;
                    }
                    if (_address.length === 0) {
                        toastr.warning('¡Favor de completar la direccion', 'Error de Datos!');
                        return false;
                    }
                }
            }

            if ($('#id_district').val() === 0) {
                toastr.warning('¡Favor de seleccionar un distrito', 'Error de Datos!');
                return false;
            }

            let client_dict = {
                "ClientTypeDocument": _document_type,
                "ClientDocumentNumber": _document_number,
                "ClientNames": _names,
                "ClientPhone": _phone,
                "ClientEmail": _email,
                "ClientAddress": _address,
                "ClientDistrict": _district,
                "ClientReference": _reference,
            }

            $.ajax({
                url: '/sales/save_new_client_sale/',
                async: true,
                dataType: 'json', // for response
                type: 'GET',
                data: {'client_dict': JSON.stringify(client_dict)},
                contentType: 'application/json;charset=UTF-8',
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        toastr.success(response.message, '¡Mensaje!');
                        $('#modalClient').modal('hide');
                        $('#document_number_client').val('');
                        $('#client-names').val('');
                        $('#client-phone').val('');
                        $('#client-email').val('');
                        $('#client-address').val('');
                        $('#id_district').val(0);
                        $('#client-reference').val('');

                        $("#id_sender").val(response.names);
                        $("#id-client-sender").val(response.client_id);
                        $("#id_address").val(response.client_address);
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    toastr.error(jqXhr.responseJSON.error, '¡ERROR DE DATOS!');
                }
            });
        });

        /*$(document).on('click', '#btn-update-order', function (e) {

            if ($('#id-type-order').val() === 'T') {
                if ($('#id_date_completion').val() === '' || $('#id_place_delivery').val() === '' || $('#id_type_quotation').val() === '0' || $('#id_name_type_quotation').val() === '' || $('#id_observation').val() === '') {
                    toastr.warning('Complete los campos de la cotización');
                    return false;
                }
            }
            if ($('#id_order_sale_quotation').val() === '') {
                toastr.warning('No existe cotizacion, actualice si es necesario');
                return false;

            }

            if (hasRowDetails() === false) {
                toastr.warning('¡Elija los productos..!', 'Mensaje');
                return false;
            }

            let sales = {
                "Details": [],
                "Client": $('#id-client-sender').val(),
                "SaleTotal": $('#sum-total').val(),
                "TransactionPaymentType": $('#transaction_payment_type').val(),
                "Distribution": $('#id_distribution').val(),
                "Type": 'T',
                "order_type": $('#id-type-order').val(),
                "Serie": $('#id_serie').val(),
                "BillType": sessionStorage.BillType,
                "issueDate": $('#issue_date').val(),
                "Demo": ($('#demo').is(':checked')) ? 1 : 0,
                "type_payment": $('#transaction_payment_type').val(),
                "cash": $('#id_cash').val(),
                "date_cash": $('#id_date').val(),
                "cash_deposit": $('#id_cash_deposit').val(),
                "cod_operation": $('#code-operation').val(),
                "validity_date": $('#id_validity_date').val(),
                "date_completion": $('#id_date_completion').val(),
                "place_delivery": $('#id_place_delivery').val(),
                "type_quotation": $('#id_type_quotation').val(),
                "observation": $('#id_observation').val(),
                "name_type_quotation": $('#id_name_type_quotation').val(),
                "order_sale_quotation": Number($('#id_order_sale_quotation').val()),
                "correlative_sale": $('#id_order_sale_quotation_correlative').val(),
            };

            $("#sales-details tr").each(function () {
                let _quantity = $(this).find("td.item-quantity input.input-quantity").val();
                if (_quantity === '' || _quantity <= 0) {
                    toastr.warning('Ingrese un valor valido para la cantidad');
                    return false
                }
                let _price = $(this).find("td.item-price input.input-price").val();
                if (_price === '' || _quantity <= 0) {
                    toastr.warning('Ingrese un valor valido para el precio');
                    return false
                }
                let detailObj = {
                    "Detail": $(this).attr('detail_id'),
                    "Product": $(this).attr('product'),
                    "Unit": $(this).find("td.item-unit").attr('pu'),
                    "Quantity": parseFloat($(this).find("td.item-quantity input.input-quantity").val()).toFixed(2),
                    "Price": parseFloat($(this).find("td.item-price input.input-price").val()).toFixed(2),
                    "DetailTotal": parseFloat($(this).find("td.item-total input.input-total-detail").val()).toFixed(2),
                    "_commentary": $(this).find("td.item-product input.input-product-name").val(),
                    "Store": $(this).attr("store_p")
                };
                sales.Details.push(detailObj);
            });

            console.log(sales)

            $.ajax({
                url: '/sales/update_quotation/',
                async: true,
                dataType: 'json', // for response
                type: 'GET',
                data: {'sales': JSON.stringify(sales)},
                contentType: 'application/json;charset=UTF-8',
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        toastr.success(response.message + response.msg_sunat, '¡Mensaje!');
                        window.open("/sales/print_quotation/" + response.id_sales + "/" + 'T' + "/", '_blank');
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    toastr.error(jqXhr.responseJSON.error, '¡ERROR DE SUNAT!');
                }
            });

        });*/

        $(document).on('focusin', '.client-table', function (e) {
            $(this).parent('td').find('div.dropdown-menu').css({
                'background-color': 'transparent',
                'border': 'transparent',
            })
            $(this).val(' ');
            $('#id_unit_product').val('0')
            $('#id_sender').val('');
            $('#id-nro-document-sender').val('');
            $('#id_address').val('');
            $('#document_type_sender').val('0');
            $('#document_type_sender').trigger('change');
        });

        $(document).on('keypress', '.client-table', function (e) {

            $(this).parent('td').find('div.dropdown-menu').empty()

            if (e.keyCode === 13) {

                e.preventDefault()

                $(this).trigger("enterKey");
                let _client_name = $(this).val();
                let _td = $(this).parent('td')
                let _menu = _td.find('.dropdown-menu')

                if (_client_name.length > 3) {

                    $.ajax({
                        url: '/sales/get_clients_by_criteria/',
                        async: true,
                        dataType: 'json', // for response
                        type: 'GET',
                        data: {
                            'value': _client_name,
                        },
                        contentType: 'application/json;charset=UTF-8',
                        headers: {"X-CSRFToken": '{{ csrf_token }}'},
                        success: function (response, textStatus, xhr) {
                            if (xhr.status === 200) {
                                let list = response.client_list;
                                _menu.css({'background-color': '#fff', 'border': '1px solid rgba(0,0,0,.15)'})
                                for (let i = 0; i < list.length; i++) {
                                    _menu.append(`<a class="dropdown-item client-item" client_name="${list[i].client_names}" client_document_number="${list[i].client_document_number}" client_address="${list[i].client_address}" client_type_document="${list[i].client_type_document}" href="#" data-id="${list[i].client_id}">cliente: ${list[i].client_names} - ${list[i].client_type}: ${list[i].client_document_number}</a>`)
                                }
                            }
                        },
                        error: function (jqXhr, textStatus, xhr) {
                            if (jqXhr.status === 500) {
                                toastr.error(jqXhr.responseJSON.error, 'Mensaje');
                            } else {
                                if (textStatus === 'timeout') {
                                    toastr.error('Failed from timeout', 'Mensaje');
                                } else {
                                    console.log(" STATUS: " + xhr + " " + textStatus);
                                }
                            }
                        }
                    });
                } else {
                    toastr.warning('Para la busqueda ingrese minimo 3 caracteres', 'Error de llenado');
                    return false;
                }
            }
        });

        $(document).on('click', '.client-item', function (e) {

            let _client_id = $(this).attr('data-id');
            let _client_address = $(this).attr('client_address');
            let _client_name = $(this).attr('client_name');
            let _tr = $(this).parent('div.dropdown-menu').parent('td').parent('tr')
            let _td = $(this).parent('div.dropdown-menu').parent('td')
            let _client_type_document = $(this).attr('client_type_document')
            let _client_document_number = $(this).attr('client_document_number')

            $('#document_type_sender').val(_client_type_document);
            $('#document_type_sender').trigger('change');

            $('#id_sender').val(_client_name);
            $('#id_address').val(_client_address);
            $("#id-nro-document-sender").val(_client_document_number);
            $("#id-client-sender").val(_client_id);
            $(".client-table").val(_client_name);

            $(this).parent('div.dropdown-menu').empty()
            $(this).parent('div.dropdown-menu').addClass('hide')
        });

        async function check_stock(_quantity, _product_id) {

            let _flag_stock = true

            await $.ajax({
                url: '/sales/check_stock/',
                async: true,
                dataType: 'json', // for response
                type: 'GET',
                data: {
                    'quantity': _quantity,
                    'product': _product_id
                },
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        {#console.log(response.flag)#}
                        _flag_stock = response.flag;
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    toastr.error('¡ERROR!');
                }
            });
            return _flag_stock
        }

        async function get_last_number_others() {

            let new_n_order = 0;

            await $.ajax({
                url: '/sales/get_last_id_type_others/',
                async: true,
                dataType: 'json', // for response
                type: 'GET',
                data: {},
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        new_n_order = response.new_n_order;
                        //console.log(new_n_order)
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    toastr.error('¡ERROR!');
                }
            });
            return new_n_order

        }

        function AddDetailsCredit() {
            let _amount = 0
            let total = parseFloat($('#sum-total').val()).toFixed(2);
            let valor = parseFloat($('#amount-credit-total').val()).toFixed(2);
            let _days = isNaN(parseInt($('#condition_days').val(), 10)) ? 0 : parseInt($('#condition_days').val(), 10);
            let dateInput = $('#issue_date');
            let currentDate = new Date(dateInput.val())
            currentDate.setDate(currentDate.getDate() + 1);
            currentDate.setDate(currentDate.getDate() + _days);
            let year = currentDate.getFullYear();
            let month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
            let day = currentDate.getDate().toString().padStart(2, '0');
            let formattedDate = `${year}-${month}-${day}`;

            _amount = parseFloat(total - valor).toFixed(2)
            if (_amount > 0) {
                $('#credit_details').append(
                    '<tr class="text-uppercase small text-center" style="font-size: 14px;">' +
                    '<td class="align-middle pt-0">' + '</td>' +
                    '<td class="align-middle item-date-credit pt-0">' + '<input type="date" class="form-control form-control-sm input-date" value="' + formattedDate + '">' + '</td>' +
                    '<td class="align-middle item-amount-credit pt-0">' + '<input type="text" step="0.01" class="form-control form-control-sm text-right input-amount" value="' + _amount + '">' + '</td>' +
                    '<td class="align-middle item-delete pt-0">' + '<button type="button"  class="btn btn-secondary btn-sm">' +
                    '<i class="fa fa-trash"></i></button>' + '</td>' +
                    '</tr>'
                );
                calculateTotalPayment();
                counterStrikePayment();
            } else {
                toastr.warning('Monto completado')
            }
        }

        function calculateTotalPayment() {
            let sum = 0;
            $('#credit_details tr td.item-amount-credit input.input-amount').each(function () {
                sum = sum + parseFloat($(this).val());
                if (sum > $('#id-total-guide').val()) {
                    toastr.warning('Monto superado')
                    sum = sum - parseFloat($(this).val());
                    $(this).val('')
                }
            });
            $('#amount-credit-total').val(sum.toFixed(2))
        }

        function counterStrikePayment() {
            let ind = 1;
            $('#credit_details tr').each(function () {
                $(this).attr('i', ind);
                $(this).children('td:first').text(ind);
                $(this).find('td.item-delete button').attr('onclick', 'deleteItemCredit(' + ind + ')')
                ind++;
            });
        }

        function deleteItemCredit($pk) {
            $('#credit_details').find("tr[i=" + $pk + "]").remove();
            calculateTotalPayment();
            counterStrikePayment();
        }

        $(document).on('keyup', '#credit_details tr td.item-amount-credit input.input-amount', function (e) {
            let val = $(this).val();
            if (isNaN(val)) {
                $(this).val('')
            } else {
                if (val !== '') {
                    calculateTotalPayment();
                }
            }
        })

        function hasRowDetailsCredits() {
            var _response = false;
            if ($("#credit_details tr").length > 0) {
                _response = true;
            }
            return _response;
        }

        $(document).on('click', '.btn-stock', function (e) {
            let productID = $(this).attr("product");
            let store_id = $(this).attr("ps");
            let stock = $(this).text().trim();
            if (stock <= 0) {
                let foundPending = false;
                let product = product_dict.find(p => p.id === parseInt(productID));
                if (product) {
                    let productStore = product.product_store.find(ps => ps.id === parseInt(store_id));
                    if (productStore) {
                        productStore.serial.forEach(serial => {
                            if (serial.status === 'P') {
                                foundPending = true;
                            }
                        });
                    }
                }
                if (foundPending) {
                    openModalStock(store_id)
                } else {
                    toastr.warning('No tiene stock del producto seleccionado', 'Error de llenado');
                    return false;
                }
            } else {
                openModalStock(store_id)
            }

        });

        function openModalStock(store_id) {
            $.ajax({
                url: '/sales/modal_serial/',
                dataType: 'json',
                type: 'GET',
                data: {'ps': store_id},
                success: function (response, textStatus, xhr) {
                    if (response.success) {
                        $('#modal-serial').html(response.form);
                        $('#modal-serial').modal('show');

                    } else {
                        toastr.error(response.message, 'Error');
                    }
                },
                fail: function (response) {
                    toastr.error('Ocurrio un problema al mostrar el formulario', '¡Mensaje!');
                }
            });
        }

        $(document).on('click', '.open-image-modal', function (e) {
            var productPk = $(this).attr('pk');
            $.ajax({
                url: '/sales/get_product_photo/',
                method: 'GET',
                data: {'pk': productPk},
                success: function (data) {
                    $('#modalImage').attr('src', data.image_url);
                    $('#imageModalLabel').text(data.product_name);
                    $('#imageModal').modal('show');
                },
                error: function (xhr, status, error) {
                    console.error("Error al obtener los datos: ", error);
                }
            });
        });

        $(document).on('change', '#type_bill_document', function (e) {
            let type_bill_document = $(this).val();
            $.ajax({
                url: '/sales/get_correlative_by_type/',
                method: 'GET',
                data: {'type_bill_document': type_bill_document},
                success: function (data) {
                    $('#correlative').val(data.correlative)
                    $('#id_serial').val(data.serial)
                },
                error: function (xhr, status, error) {
                    console.error("Error al obtener los datos: ", error);
                }
            });

        });


    </script>

{% endblock extrajs %}
